"use strict";(self.webpackChunklfx_rushstack_io=self.webpackChunklfx_rushstack_io||[]).push([[966],{158:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>m});var r=n(6393);function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,r,s=function(e,t){if(null==e)return{};var n,r,s={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(s[n]=e[n]);return s}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(s[n]=e[n])}return s}var l=r.createContext({}),p=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=p(e.components);return r.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},h=r.forwardRef((function(e,t){var n=e.components,s=e.mdxType,a=e.originalType,l=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),h=p(n),m=s,d=h["".concat(l,".").concat(m)]||h[m]||u[m]||a;return n?r.createElement(d,i(i({ref:t},c),{},{components:n})):r.createElement(d,i({ref:t},c))}));function m(e,t){var n=arguments,s=t&&t.mdxType;if("string"==typeof e||s){var a=n.length,i=new Array(a);i[0]=h;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o.mdxType="string"==typeof e?e:s,i[1]=o;for(var p=2;p<a;p++)i[p]=n[p];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}h.displayName="MDXCreateElement"},640:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>l,default:()=>m,frontMatter:()=>o,metadata:()=>p,toc:()=>u});var r=n(216),s=n(2228),a=(n(6393),n(158)),i=["components"],o={title:"Strict settings"},l=void 0,p={unversionedId:"pages/concepts/strict_settings",id:"pages/concepts/strict_settings",title:"Strict settings",description:'Many lockfile problems can be avoided by enabling various "strict" settings for',source:"@site/docs/pages/concepts/strict_settings.md",sourceDirName:"pages/concepts",slug:"/pages/concepts/strict_settings",permalink:"/pages/concepts/strict_settings",draft:!1,editUrl:"https://github.com/microsoft/rushstack-websites/tree/main/websites/lfx.rushstack.io/docs/pages/concepts/strict_settings.md",tags:[],version:"current",frontMatter:{title:"Strict settings"},sidebar:"docsSidebar",previous:{title:"The PNPM lockfile",permalink:"/pages/concepts/pnpm_lockfile"},next:{title:"Demos repository",permalink:"/pages/scenarios/demos_repo"}},c={},u=[{value:"strictPeerDependencies",id:"strictpeerdependencies",level:2},{value:"ensureConsistentVersions",id:"ensureconsistentversions",level:2},{value:"Disable PNPM hoisting",id:"disable-pnpm-hoisting",level:2},{value:"preventManualShrinkwrapChanges",id:"preventmanualshrinkwrapchanges",level:2},{value:"Settings hardwired by Rush",id:"settings-hardwired-by-rush",level:2},{value:"Settings to avoid",id:"settings-to-avoid",level:2}],h={toc:u};function m(e){var t=e.components,n=(0,s.Z)(e,i);return(0,a.kt)("wrapper",(0,r.Z)({},h,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,'Many lockfile problems can be avoided by enabling various "strict" settings for\nRush and PNPM. These settings activate additional validation checks and disable\nsome "magic" features that try to hide problems caused by an incorrect lockfile.'),(0,a.kt)("p",null,"These strict settings are disabled by default, because it can take some effort\nto get them enabled in a preexisting mononrepo. Once enabled, engineers may encounter\nversioning errors more frequently in their day to day work, but these errors are generally\nless costly to manage than the much deeper problems that can arise in a monorepo\nwith inherent version conflicts, whose engineers learned about versioning by studying\nan environment that is fundamentally broken."),(0,a.kt)("h2",{id:"strictpeerdependencies"},"strictPeerDependencies"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Difficulty Level: Easy")),(0,a.kt)("p",null,"It can take some work to get ",(0,a.kt)("inlineCode",{parentName:"p"},"strictPeerDependencies")," initially enabled in a legacy monorepo;\nhowever, once your lockfile is in a clean state, it's relatively easy to fix any future errors\nthat arise."),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://rushjs.io/pages/configs/pnpm-config_json/"},"common/config/rush/pnpm-config.json")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},'  . . .\n  /**\n   * If true, then Rush will add the `--strict-peer-dependencies` command-line parameter when\n   * invoking PNPM.  This causes `rush update` to fail if there are unsatisfied peer dependencies,\n   * which is an invalid state that can cause build failures or incompatible dependency versions.\n   * (For historical reasons, JavaScript package managers generally do not treat this invalid\n   * state as an error.)\n   *\n   * PNPM documentation: https://pnpm.io/npmrc#strict-peer-dependencies\n   *\n   * The default value is false to avoid legacy compatibility issues.\n   * It is strongly recommended to set `strictPeerDependencies=true`.\n   */\n  "strictPeerDependencies": true,\n  . . .\n')),(0,a.kt)("h2",{id:"ensureconsistentversions"},"ensureConsistentVersions"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Difficulty Level: Medium")),(0,a.kt)("p",null,"It can take some work to get ",(0,a.kt)("inlineCode",{parentName:"p"},"ensureConsistentVersions")," enabled in a legacy monorepo, however once\nyour versions are consistent, it's relatively easy to fix any future errors that arise. For any difficult\ncases, you can simply exempt the affected package using ",(0,a.kt)("inlineCode",{parentName:"p"},"allowedAlternativeVersions"),"."),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://rushjs.io/pages/configs/rush_json/"},"rush.json")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},'/**\n * If you would like the version specifiers for your dependencies to be consistent, then\n * uncomment this line. This is effectively similar to running "rush check" before any\n * of the following commands:\n *\n *   rush install, rush update, rush link, rush version, rush publish\n *\n * In some cases you may want this turned on, but need to allow certain packages to use a different\n * version. In those cases, you will need to add an entry to the "allowedAlternativeVersions"\n * section of the common-versions.json.\n */\n// "ensureConsistentVersions": true,\n')),(0,a.kt)("h2",{id:"disable-pnpm-hoisting"},"Disable PNPM hoisting"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Difficulty level: Advanced")),(0,a.kt)("p",null,"This setting is somewhat challenging in a large monorepo, because many hoisted dependencies\nmay require fixups. We were able to successfully enable this setting in the\n",(0,a.kt)("a",{parentName:"p",href:"https://github.com/microsoft/rushstack/"},"microsoft/rushstack"),"\nmonorepo where Lockfile Explorer is developed. For some thoughts about a more gradual\nmigration path, see\n",(0,a.kt)("a",{parentName:"p",href:"https://github.com/microsoft/rushstack/issues/3635"},"Design Proposal #3635"),"."),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://rushjs.io/pages/configs/npmrc/"},"common/config/rush/.npmrc")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"# Disable hoisted phantom dependencies in this repository.  PNPM has two separate\n# settings for hoisting, but they have equivalent effects because Rush monorepo\n# relocates the workspace root to the \"common/temp\" path.\n\n# 1. Don't hoist under common/temp/node_modules/\npublic-hoist-pattern=\n\n# 2. Don't hoist under common/temp/node_modules/.pnpm/node_modules/\nhoist=false\nhoist-pattern=\n")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"NOTE: In the future, we plan to replace these ",(0,a.kt)("inlineCode",{parentName:"p"},".npmrc")," settings\nwith an official Rush setting with JSON schema validation and\na more intuitive interface. See\n",(0,a.kt)("a",{parentName:"p",href:"https://github.com/microsoft/rushstack/issues/3542"},"GitHub Issue #3542"),"\nfor discussion.")),(0,a.kt)("h2",{id:"preventmanualshrinkwrapchanges"},"preventManualShrinkwrapChanges"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Difficulty Level: Easy")),(0,a.kt)("p",null,"To reduce the likelihood of merge conflicts, we recommend waiting to enable this setting\nuntil you start encountering problems caused by people manually tampering with the lockfile."),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://rushjs.io/pages/configs/pnpm-config_json/"},"common/config/rush/pnpm-config.json")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},'  . . .\n /**\n   * If true, then `rush install` will report an error if manual modifications\n   * were made to the PNPM shrinkwrap file without running `rush update` afterwards.\n   *\n   * This feature protects against accidental inconsistencies that may be introduced\n   * if the PNPM shrinkwrap file (`pnpm-lock.yaml`) is manually edited.  When this\n   * feature is enabled, `rush update` will append a hash to the file as a YAML comment,\n   * and then `rush update` and `rush install` will validate the hash.  Note that this\n   * does not prohibit manual modifications, but merely requires `rush update` be run\n   * afterwards, ensuring that PNPM can report or repair any potential inconsistencies.\n   *\n   * To temporarily disable this validation when invoking `rush install`, use the\n   * `--bypass-policy` command-line parameter.\n   *\n   * The default value is false.\n   */\n  "preventManualShrinkwrapChanges": true,\n  . . .\n')),(0,a.kt)("h2",{id:"settings-hardwired-by-rush"},"Settings hardwired by Rush"),(0,a.kt)("p",null,"If you're using the Rush build orchestrator, these settings are always automatically enabled:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://pnpm.io/npmrc#link-workspace-packages"},"--link-workspace-packages=false")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://pnpm.io/npmrc#prefer-frozen-lockfile"},"--prefer-frozen-lockfile=false")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://pnpm.io/npmrc#ignore-compatibility-db"},"ignoreCompatibilityDb=true"))),(0,a.kt)("h2",{id:"settings-to-avoid"},"Settings to avoid"),(0,a.kt)("p",null,"It's strongly recommended NOT to enable these settings:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://pnpm.io/npmrc#shamefully-hoist"},"shamefully-hoist=true")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://pnpm.io/npmrc#auto-install-peers"},"auto-install-peers=true")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://pnpm.io/npmrc#shared-workspace-lockfile"},"shared-workspace-lockfile=false"))))}m.isMDXComponent=!0}}]);