"use strict";(self.webpackChunklfx_rushstack_io=self.webpackChunklfx_rushstack_io||[]).push([[876],{158:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>k});var a=n(6393);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),d=p(n),k=i,h=d["".concat(s,".").concat(k)]||d[k]||m[k]||r;return n?a.createElement(h,o(o({ref:t},c),{},{components:n})):a.createElement(h,o({ref:t},c))}));function k(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:i,o[1]=l;for(var p=2;p<r;p++)o[p]=n[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},8485:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>s,default:()=>k,frontMatter:()=>l,metadata:()=>p,toc:()=>m});var a=n(216),i=n(2228),r=(n(6393),n(158)),o=["components"],l={title:"The PNPM lockfile"},s=void 0,p={unversionedId:"pages/concepts/pnpm_lockfile",id:"pages/concepts/pnpm_lockfile",title:"The PNPM lockfile",description:"The previous sections covered the basics of version conflicts, SemVer, and installation models.",source:"@site/docs/pages/concepts/pnpm_lockfile.md",sourceDirName:"pages/concepts",slug:"/pages/concepts/pnpm_lockfile",permalink:"/pages/concepts/pnpm_lockfile",draft:!1,editUrl:"https://github.com/microsoft/rushstack-websites/tree/main/websites/lfx.rushstack.io/docs/pages/concepts/pnpm_lockfile.md",tags:[],version:"current",frontMatter:{title:"The PNPM lockfile"},sidebar:"docsSidebar",previous:{title:"Tracing package resolution",permalink:"/pages/concepts/tracing_resolution"},next:{title:"Strict settings",permalink:"/pages/concepts/strict_settings"}},c={},m=[{value:"Why do we need a lockfile?",id:"why-do-we-need-a-lockfile",level:2},{value:"What does a lockfile store?",id:"what-does-a-lockfile-store",level:2},{value:"How is a lockfile created?",id:"how-is-a-lockfile-created",level:2},{value:"Overall file structure",id:"overall-file-structure",level:2},{value:"Lockfile &quot;entries&quot;",id:"lockfile-entries",level:2},{value:"A package entry",id:"a-package-entry",level:2},{value:"A project entry",id:"a-project-entry",level:2},{value:"Lockfile entry identifiers",id:"lockfile-entry-identifiers",level:2}],d={toc:m};function k(e){var t=e.components,n=(0,i.Z)(e,o);return(0,r.kt)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"The previous sections covered the basics of version conflicts, SemVer, and installation models.\nWe're now ready to examine the package lockfile in detail. In a nutshell, it stores an\n",(0,r.kt)("strong",{parentName:"p"},"installation plan")," for how the ",(0,r.kt)("inlineCode",{parentName:"p"},"node_modules")," folder should get installed, according to the\n",(0,r.kt)("a",{parentName:"p",href:"/pages/concepts/install_models"},"installation model")," in use. From now on, we'll assume that it's the\nPNPM installation model, and so the filename is ",(0,r.kt)("inlineCode",{parentName:"p"},"pnpm-lock.yaml"),"."),(0,r.kt)("h2",{id:"why-do-we-need-a-lockfile"},"Why do we need a lockfile?"),(0,r.kt)("p",null,"Suppose hypothetically that we did not have a ",(0,r.kt)("inlineCode",{parentName:"p"},"pnpm-lock.yaml")," file stored in Git, and suppose also that\n",(0,r.kt)("inlineCode",{parentName:"p"},"my-app/package.json")," has a dependency on ",(0,r.kt)("inlineCode",{parentName:"p"},'"react": "^18.0.0"'),". Let's say today is May 1st, and the latest release\nfrom the 18 series is ",(0,r.kt)("inlineCode",{parentName:"p"},"react@18.1.0"),". Without a lockfile, that is what PNPM would choose to install.\nLatest is greatest, right? Well, consider a few hypothetical scenarios:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Ability to reproduce an error.")," Some time passes, and it's now June 15th. When you install ",(0,r.kt)("inlineCode",{parentName:"p"},"my-app"),",\nthe latest version is now ",(0,r.kt)("inlineCode",{parentName:"p"},"react@18.2.0"),". Suppose the app malfunctions because of a change introduced in\nthat version. But when you ask a teammate for help, they don't know what you're talking about. ",(0,r.kt)("em",{parentName:"p"},'"Everything\nruns fine on my computer!"')," The reason is that their ",(0,r.kt)("inlineCode",{parentName:"p"},"node_modules")," folder still has the old ",(0,r.kt)("inlineCode",{parentName:"p"},"react@18.1.0"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Building old branches.")," To investigate, you remember that the project worked successfully a week ago,\nso you decide to try checking out older versions of the Git branch. By pinpointing the commit that\nbroke things, maybe you can compare the diff to find the change that broke things. However because there is\nno lockfile, those old branches are all now failing as well, because ",(0,r.kt)("inlineCode",{parentName:"p"},"react@18.2.0")," is getting installed\ninstead of ",(0,r.kt)("inlineCode",{parentName:"p"},"react@18.1.0"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Deterministic releases.")," But that means... The next time we deploy to production, it's going to\ninclude ",(0,r.kt)("inlineCode",{parentName:"p"},"react@18.2.0")," and cause a customer incident. Uh oh! Essentially, we're deploying something\ndifferent from what we tested. How can we pin the version back to ",(0,r.kt)("inlineCode",{parentName:"p"},"react@18.1.0")," for a given branch?"))),(0,r.kt)("p",null,"A naive solution would be to change ",(0,r.kt)("inlineCode",{parentName:"p"},'"react": "^18.0.0"')," to ",(0,r.kt)("inlineCode",{parentName:"p"},'"react": "18.1.0"')," in ",(0,r.kt)("inlineCode",{parentName:"p"},"my-app/package.json"),",\nhowever this only affects direct dependencies of your project. A typical ",(0,r.kt)("inlineCode",{parentName:"p"},"node_modules")," folder may contain\nthousands of NPM packages, most of which are dependencies-of-dependencies, whose version range is determined\nby an external ",(0,r.kt)("inlineCode",{parentName:"p"},"package.json")," file."),(0,r.kt)("h2",{id:"what-does-a-lockfile-store"},"What does a lockfile store?"),(0,r.kt)("p",null,"The package lockfile is the ideal solution to the above problem: It records the exact version number of every\nsingle package in your ",(0,r.kt)("inlineCode",{parentName:"p"},"node_modules")," folder, along with topological information such as peer dependency\nrelationships. This enables the package manager to reproduce the exact same ",(0,r.kt)("inlineCode",{parentName:"p"},"node_modules"),' folder structure\nregardless of whatever the "latest" versions might be on that day. The ',(0,r.kt)("inlineCode",{parentName:"p"},"pnpm-lock.yaml")," file is serialized as\nhuman-readable text, in a format whose diff minimizes Git merge conflicts as much as possible. The file format\nalso carefully avoids storing extra information that might not be portable between operating systems\nor NPM registry configurations."),(0,r.kt)("h2",{id:"how-is-a-lockfile-created"},"How is a lockfile created?"),(0,r.kt)("div",{className:"markdown-table-nowrap-col-1-and-2"},(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"PNPM command"),(0,r.kt)("th",{parentName:"tr",align:null},"Rush command"),(0,r.kt)("th",{parentName:"tr",align:null},"What it does"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"pnpm update")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"rush update --full")),(0,r.kt)("td",{parentName:"tr",align:null},"Rebuilds ",(0,r.kt)("inlineCode",{parentName:"td"},"pnpm-lock.yaml")," file from scratch, choosing the latest versions that satisfy each version range specified in ",(0,r.kt)("strong",{parentName:"td"},"package.json")," files.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"pnpm install"),(0,r.kt)("br",null),"with ",(0,r.kt)("inlineCode",{parentName:"td"},"--no-frozen-lockfile")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"rush update")),(0,r.kt)("td",{parentName:"tr",align:null},"Checks whether the existing lockfile is consistent with your version ranges. If not, a minimal update is performed, preserving as much as possible from the previous lockfile.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"pnpm install"),(0,r.kt)("br",null),"with ",(0,r.kt)("inlineCode",{parentName:"td"},"--frozen-lockfile")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"rush install")),(0,r.kt)("td",{parentName:"tr",align:null},"Checks whether the existing lockfile is consistent with your version ranges. If not, Rush fails with an error message telling you  to run ",(0,r.kt)("inlineCode",{parentName:"td"},"rush update"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"pnpm install")),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Uses a heuristic to detect whether the command seems to be running in a CI environment.  If yes, the behavior is like ",(0,r.kt)("inlineCode",{parentName:"td"},"rush install"),". Otherwise, the behavior is like ",(0,r.kt)("inlineCode",{parentName:"td"},"rush update"),"."))))),(0,r.kt)("p",null,"With Rush, the lockfile is stored in ",(0,r.kt)("inlineCode",{parentName:"p"},"common/config/rush/pnpm-lockfile.yaml"),". During installation, it gets\ncopied to ",(0,r.kt)("inlineCode",{parentName:"p"},"common/temp/")," where the workspace installation occurs."),(0,r.kt)("p",null,"If you're using a PNPM workspace without Rush, then ",(0,r.kt)("inlineCode",{parentName:"p"},"pnpm-lockfile.yaml")," is instead stored in your repository's\nroot folder, next to your ",(0,r.kt)("inlineCode",{parentName:"p"},"pnpm-workspace.yaml")," file."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("strong",{parentName:"p"},'Two different meanings of "lockfile"')),(0,r.kt)("p",{parentName:"blockquote"},"In classic computing, the word ",(0,r.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/File_locking#Lock_files"},'"lock file"'),"\nhas always referred to a file that coordinates a multi-process concurrency mechanism such as a mutex.\nThe ",(0,r.kt)("inlineCode",{parentName:"p"},"@rushstack/node-core-library")," ",(0,r.kt)("a",{parentName:"p",href:"https://api.rushstack.io/pages/node-core-library.lockfile/"},"LockFile class"),"\nimplements such a mechanism."),(0,r.kt)("p",{parentName:"blockquote"},'When NPM was first introduced, its serialized installation plan was called a "shrinkwrap file",\n',(0,r.kt)("inlineCode",{parentName:"p"},"npm-shrinkwrap.json")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"shrinkwrap.yaml"),", and Rush still uses this terminology in many places.\nYarn called its file ",(0,r.kt)("inlineCode",{parentName:"p"},"yarn.lock"),", adopting a similar naming convention as Ruby's ",(0,r.kt)("inlineCode",{parentName:"p"},"Gemfile.lock"),',\nwhich people had started calling "lockfiles". For consistency, PNPM and NPM later switched to using\n"lockfile" instead of "shrinkwrap file".'),(0,r.kt)("p",{parentName:"blockquote"},"When the context is unclear, our documentation will sometimes use the term ",(0,r.kt)("strong",{parentName:"p"},"package lockfile"),"\nto avoid any confusion with concurrency lockfiles.")),(0,r.kt)("h2",{id:"overall-file-structure"},"Overall file structure"),(0,r.kt)("p",null,"Let's continue with the\n",(0,r.kt)("a",{parentName:"p",href:"https://github.com/microsoft/lockfile-explorer-demos/tree/demo/sample-1"},"demo/sample-1"),"\nbranch from the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/microsoft/lockfile-explorer-demos/"},"lockfile-explorer-demos"),"\ndemo repo, which we already saw in the ",(0,r.kt)("a",{parentName:"p",href:"/pages/concepts/tracing_resolution"},"Tracing package resolution")," section."),(0,r.kt)("p",null,"Recall that the ",(0,r.kt)("inlineCode",{parentName:"p"},"demo/sample-1")," lockfile looks like this:"),(0,r.kt)("img",{src:"https://raw.githubusercontent.com/microsoft/lockfile-explorer-demos/demo/sample-1/common/images/lfx-demo-sample-1.svg",alt:"dependency graph: demo/sample-1"}),(0,r.kt)("p",null,"Let's examine the corresponding YAML file. Using ",(0,r.kt)("inlineCode",{parentName:"p"},"...")," to fold the YAML subtrees, the top-level file structure\nlooks like this:"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/microsoft/lockfile-explorer-demos/blob/demo/sample-1/common/config/rush/pnpm-lock.yaml"},"lockfile-explorer-demos/common/config/rush/pnpm-lock.yaml")," (",(0,r.kt)("inlineCode",{parentName:"p"},"demo/sample-1")," branch)"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"lockfileVersion: 5.4\n\nimporters:\n  .: ...\n  ../../projects/a: ...\n  ../../projects/b: ...\n  ../../projects/c: ...\n  ../../projects/d: ...\n  ../../projects/e: ...\n\npackages:\n  /@rushstack/j/1.0.0_@rushstack+n@2.0.0: ...\n  /@rushstack/k/1.0.0_@rushstack+m@1.0.0: ...\n  /@rushstack/k/1.0.0_wxpgugna4ivthu7yyu4fmciltu: ...\n  /@rushstack/l/1.0.0_@rushstack+m@1.0.0: ...\n  /@rushstack/l/1.0.0_wxpgugna4ivthu7yyu4fmciltu: ...\n  /@rushstack/m/1.0.0: ...\n  /@rushstack/n/2.0.0: ...\n  /@rushstack/n/3.0.0: ...\n")),(0,r.kt)("p",null,"Comparing with the diagram, the ",(0,r.kt)("inlineCode",{parentName:"p"},"importers")," section represents our local projects in the workspace.\nThe ",(0,r.kt)("inlineCode",{parentName:"p"},"packages")," section represents the external NPM packages downloaded from the NPM registry."),(0,r.kt)("p",null,"The YAML key for local projects is their file path, relative to the folder of ",(0,r.kt)("inlineCode",{parentName:"p"},"common/temp/pnpm-workspace.yaml"),",\nwhich Rush generates from its project inventory in ",(0,r.kt)("strong",{parentName:"p"},"rush.json"),". The empty ",(0,r.kt)("inlineCode",{parentName:"p"},".:")," key corresponds to the\nroot ",(0,r.kt)("inlineCode",{parentName:"p"},"common/temp/package.json")," which is generated by Rush."),(0,r.kt)("p",null,"The YAML key for external packages appears to be a combination of the package name and version. For\nexample, ",(0,r.kt)("inlineCode",{parentName:"p"},"@rushstack/n")," version ",(0,r.kt)("inlineCode",{parentName:"p"},"3.0.0")," becomes ",(0,r.kt)("inlineCode",{parentName:"p"},"/@rushstack/n/3.0.0"),"."),(0,r.kt)("p",null,"But what are these strange entries with ",(0,r.kt)("inlineCode",{parentName:"p"},"_")," suffixes? The answer is that they are ",(0,r.kt)("strong",{parentName:"p"},"peer doppelgangers"),"\n-- multiple installs of the same version of the same package. Although the\n",(0,r.kt)("a",{parentName:"p",href:"/pages/concepts/install_models"},"PNPM installation model")," eliminates NPM doppelgangers, it still needs to create\ndoppelgangers in the case of a peer dependency. For example, in the diagram we can see that ",(0,r.kt)("inlineCode",{parentName:"p"},"@rushstack/k"),"\nversion ",(0,r.kt)("inlineCode",{parentName:"p"},"1.0.0")," needs to be installed in two separate folder locations:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"/@rushstack/k/1.0.0_@rushstack+m@1.0.0")," provides ",(0,r.kt)("inlineCode",{parentName:"p"},"K@1")," with peer ",(0,r.kt)("inlineCode",{parentName:"p"},"M@1"),", installed into:",(0,r.kt)("br",null),"\n",(0,r.kt)("inlineCode",{parentName:"p"},".pnpm/@rushstack+k@1.0.0_@rushstack+m@1.0.0/node_modules/@rushstack/k"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"/@rushstack/k/1.0.0_wxpgugna4ivthu7yyu4fmciltu")," provides ",(0,r.kt)("inlineCode",{parentName:"p"},"K@1")," with both peer ",(0,r.kt)("inlineCode",{parentName:"p"},"M@1")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"N@2"),", installed into:",(0,r.kt)("br",null),"\n",(0,r.kt)("inlineCode",{parentName:"p"},".pnpm/@rushstack+k@1.0.0_wxpgugna4ivthu7yyu4fmciltu/node_modules/@rushstack/k>")))),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},".pnpm")," disk folder can be found under ",(0,r.kt)("inlineCode",{parentName:"p"},"common/temp/node_modules/"),", and PNPM's various symlinks will ultimately\npoint into paths under this folder. The exact disk paths are implementation details and therefore not captured in\nthe lockfile; to observe them, you need to run ",(0,r.kt)("inlineCode",{parentName:"p"},"rush install")," and then inspect the resulting ",(0,r.kt)("inlineCode",{parentName:"p"},"common/temp")," folder."),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"_@rushstack+m@1.0.0")," suffix is really just an informational label to improve readability for humans.\nIn cases where the generated label would be too long, PNPM falls back to using a hashed string such\nas ",(0,r.kt)("inlineCode",{parentName:"p"},"_wxpgugna4ivthu7yyu4fmciltu"),"."),(0,r.kt)("h2",{id:"lockfile-entries"},'Lockfile "entries"'),(0,r.kt)("p",null,"Lockfile Explorer refers to the ",(0,r.kt)("inlineCode",{parentName:"p"},"importers:")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"packages:")," items as ",(0,r.kt)("strong",{parentName:"p"},"lockfile entries"),". It's important\nto understand that \"entries\" don't correspond to package versions, but rather ",(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("em",{parentName:"strong"},"folders on disk"))," where\na package version got installed: A single package version may produce multiple lockfile entries,\nin the case of doppelgangers."),(0,r.kt)("p",null,"The Lockfile Explorer UI displays ",(0,r.kt)("inlineCode",{parentName:"p"},"importers:"),' on the "Projects" tab. The ',(0,r.kt)("inlineCode",{parentName:"p"},"packages:"),' are displayed the "Packages" tab.'),(0,r.kt)("p",null,"\ud83d\udc49 Now's a good time to run ",(0,r.kt)("inlineCode",{parentName:"p"},"lockfile-explorer")," in your ",(0,r.kt)("inlineCode",{parentName:"p"},"demo/sample-1")," checkout workspace, to see how\nthese lockfile entries appear in the UI."),(0,r.kt)("h2",{id:"a-package-entry"},"A package entry"),(0,r.kt)("p",null,"Here's an example entry from the ",(0,r.kt)("inlineCode",{parentName:"p"},"packages:")," section, describing an install of ",(0,r.kt)("inlineCode",{parentName:"p"},"@rushstack/l")," version ",(0,r.kt)("inlineCode",{parentName:"p"},"1.0.0"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"/@rushstack/l/1.0.0_wxpgugna4ivthu7yyu4fmciltu:\n  resolution:\n    {\n      integrity: sha512-j9Pr82osu3t22rasnYg2pp/wMjMtg7KXu3WY59onaxHht/E8TgKqTWj4Mas2q+dF2xxs/vho9PdYKRlaXDzkhA==\n    }\n  peerDependencies:\n    '@rushstack/m': ^1.0.0\n    '@rushstack/n': ^2.0.0\n  peerDependenciesMeta:\n    '@rushstack/n':\n      optional: true\n  dependencies:\n    '@rushstack/m': 1.0.0\n    '@rushstack/n': 2.0.0\n  dev: false\n")),(0,r.kt)("p",null,"We can see several fields:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"resolution:")," has a tarball hash, used in the case where an NPM registry allowed a package to be republished with\ndifferent content (a deprecated practice)"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"dependencies:")," lists the ",(0,r.kt)("inlineCode",{parentName:"li"},"dependencies")," of this package, and the exact lockfile entry that was chosen\nto match their version range."),(0,r.kt)("li",{parentName:"ul"},"The ",(0,r.kt)("inlineCode",{parentName:"li"},"dependencies:")," field actually combines both regular and ",(0,r.kt)("inlineCode",{parentName:"li"},"devDependencies"),", because the installation\nplan doesn't care /why/ something is a dependency; it ultimately needs to be installed or not"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"dev:")," will be ",(0,r.kt)("inlineCode",{parentName:"li"},"true")," if this package was only ever referenced via ",(0,r.kt)("inlineCode",{parentName:"li"},"devDependencies"),". It is used by\nPNPM's ",(0,r.kt)("a",{parentName:"li",href:"https://pnpm.io/cli/install#--dev--d"},"--dev parameter"),"."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"peerDependencies:")," tracks the peer dependencies specially, since managing them is one of the most complex\naspects of the PNPM algorithm."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"peerDependenciesMeta:")," tracks whether they are optional or not")),(0,r.kt)("h2",{id:"a-project-entry"},"A project entry"),(0,r.kt)("p",null,"Perhaps surprisingly, the ",(0,r.kt)("inlineCode",{parentName:"p"},"importers:")," section for local projects has a somewhat different structure,\neven though both are described by the same ",(0,r.kt)("strong",{parentName:"p"},"package.json")," input format. Let's see if we can explain why:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"../../projects/c:\n  specifiers:\n    '@rushstack/e': workspace:*\n    '@rushstack/k': ^1.0.0\n    '@rushstack/m': ~1.0.0\n  dependencies:\n    '@rushstack/e': link:../e\n    '@rushstack/k': 1.0.0_@rushstack+m@1.0.0\n    '@rushstack/m': 1.0.0\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"specifiers:")," remembers the original SemVer ranges from ",(0,r.kt)("strong",{parentName:"p"},"package.json"),". Because this package was not\npublished to an NPM registry, its ",(0,r.kt)("strong",{parentName:"p"},"package.json")," file can be manually modified at any time, so the\nlockfile needs to detect such changes. In other words, the lockfile needs to capture more details about\nlocal projects, because they are mutable whereas published packages are (mostly) immutable.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"dependencies:")," tracks the dependencies in the same way as the ",(0,r.kt)("inlineCode",{parentName:"p"},"packages:")," section.\nThe ",(0,r.kt)("inlineCode",{parentName:"p"},"link:../e")," string describes a dependency that will be symlinked to a local project folder,\nfor example due to a ",(0,r.kt)("inlineCode",{parentName:"p"},"workspace:*")," specifier in ",(0,r.kt)("strong",{parentName:"p"},"package.json"),".")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Note that ",(0,r.kt)("inlineCode",{parentName:"p"},"peerDependencies")," never appears in this section. The reason is that PNPM does not properly\ninstall peer dependencies for local projects. Why? Well, as we've seen, peer dependencies are installed\nby creating peer doppelganger folders -- multiple copies of the package folder. But for a local project\nthat is built from source code, how would that work? Whenever you recompile the code, there would need\nto be some mechanism that copies the output into the various doppelganger folders under ",(0,r.kt)("inlineCode",{parentName:"p"},"node_modules"),".\nIn practice it doesn't cause much trouble, but nonetheless it's a somewhat important limitation to understand,\nas it explains some weirdness with peer dependencies for local projects.\nSee ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/pnpm/pnpm/issues/4407#issuecomment-1125470213"},"PNPM#4407"),"\nfor our current thinking about it."))),(0,r.kt)("h2",{id:"lockfile-entry-identifiers"},"Lockfile entry identifiers"),(0,r.kt)("p",null,"Looking at the above snippets, you may notice that the ",(0,r.kt)("inlineCode",{parentName:"p"},"dependencies:")," section uses a different\nentry identifier syntax than the YAML keys. For example:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"../../projects/e")," from ",(0,r.kt)("inlineCode",{parentName:"li"},"importers:")," gets referenced as ",(0,r.kt)("inlineCode",{parentName:"li"},"../e"),". The path is relative to ",(0,r.kt)("inlineCode",{parentName:"li"},"projects/c")," instead\nof relative to ",(0,r.kt)("inlineCode",{parentName:"li"},"common/temp/pnpm-workspace.yaml"),"."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"/@rushstack/k/1.0.0_@rushstack+m@1.0.0")," from ",(0,r.kt)("inlineCode",{parentName:"li"},"packages:")," gets referenced as\n",(0,r.kt)("inlineCode",{parentName:"li"},"'@rushstack/k': 1.0.0_@rushstack+m@1.0.0"),".")),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"dependencies:")," uses a shortened form of the lockfile entry identifier, probably because it yields\nsignificant file compression for the YAML file, and maybe is a little easier to read. However this inconsistency\nmakes it somewhat difficult to traverse the dependency graph by searching for strings in your text editor.\nThis was one of the major motivations for creating the Lockfile Explorer app."))}k.isMDXComponent=!0}}]);